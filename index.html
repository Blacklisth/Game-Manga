<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cavalier Jumper Pro - √âdition Professionnelle</title>
    <style>
        :root {
            --primary: #FF6B35;
            --dark: #2F3E46;
            --sky: #87CEEB;
            --glow: rgba(255,107,53,0.6);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            touch-action: none;
            overflow: hidden;
        }
        .game-wrapper {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 10px;
        }
        .ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }
        .stat-box {
            background: rgba(0,0,0,0.7);
            padding: 12px 24px;
            border-radius: 25px;
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            font-weight: bold;
            font-size: 1.1rem;
        }
        canvas {
            width: 100%;
            height: auto;
            display: block;
            background: var(--sky);
            border-radius: 25px;
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.6);
            touch-action: none;
        }
        .controls-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 25px;
            pointer-events: all;
        }
        .control-btn {
            width: 90px;
            height: 90px;
            background: rgba(255,255,255,0.15);
            border: 3px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .control-btn:active, .control-btn.active {
            background: var(--primary);
            transform: scale(0.92);
            box-shadow: 0 5px 20px var(--glow);
        }
        #btnJump { width: 140px; border-radius: 25px; font-size: 1rem; }
        
        /* √âcrans */
        .screen {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 25px;
            z-index: 100;
            backdrop-filter: blur(20px);
        }
        .screen.active { display: flex; }
        .screen h1 { font-size: 4rem; margin-bottom: 20px; text-shadow: 0 0 20px var(--glow); }
        .screen p { font-size: 1.6rem; color: #ccc; margin-bottom: 30px; }
        .btn {
            background: linear-gradient(45deg, var(--primary), #FF8E53);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.3rem;
            border-radius: 35px;
            cursor: pointer;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            box-shadow: 0 10px 30px var(--glow);
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px var(--glow); }
        .btn:active { transform: translateY(-1px); }
        
        /* Pause */
        #pauseBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            pointer-events: all;
            z-index: 15;
            backdrop-filter: blur(10px);
        }
        #pauseBtn:hover { background: var(--primary); }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div class="ui-overlay">
            <div class="stat-box">Score: <span id="score">0</span></div>
            <div class="stat-box">Niveau: <span id="level">1</span></div>
            <div class="stat-box">Meilleur: <span id="highScore">0</span></div>
        </div>
        
        <button id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è</button>
        
        <canvas id="gameCanvas" width="900" height="500"></canvas>
        
        <!-- Menu Titre -->
        <div class="screen" id="titleScreen">
            <h1>üèá CAVALIER JUMPER</h1>
            <p>√âdition Professionnelle</p>
            <button class="btn" onclick="startGame()">JOUER</button>
            <p style="font-size: 1rem; margin-top: 40px; color: #aaa;">
                Saut: ESPACE ‚Üë | Bas: ‚Üì S | Pause: ‚è∏Ô∏è
            </p>
        </div>
        
        <!-- Game Over -->
        <div class="screen" id="gameOver">
            <h1>PERDU !</h1>
            <p>Score final: <span id="finalScore">0</span></p>
            <button class="btn" onclick="restartGame()">Rejouer</button>
            <button class="btn" onclick="showTitle()">Menu</button>
        </div>
        
        <!-- Pause -->
        <div class="screen" id="pauseScreen">
            <h1>PAUSE</h1>
            <button class="btn" onclick="togglePause()">Reprendre</button>
        </div>

        <div class="controls-container">
            <div class="control-btn" id="btnDuck">BAS ‚Üì</div>
            <div class="control-btn" id="btnJump">SAUT ‚Üë</div>
        </div>
    </div>

    <!-- Sons (base64 pour pro, sans d√©pendances externes) -->
    <audio id="jumpSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAo" type="audio/wav">
    </audio>
    <audio id="hitSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRl4GAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAo" type="audio/wav">
    </audio>
    <audio id="bgMusic" loop preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAo" type="audio/wav">
    </audio>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Responsive canvas
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // √âtat du jeu pro
        let gameState = 'title'; // title, playing, paused, gameover
        let score = 0;
        let highScore = localStorage.getItem('cavalierHighScore') || 0;
        let gameSpeed = 1;
        let level = 1;
        let shake = 0;
        let particles = [];
        let gameTime = 0;

        const rider = {
            x: 100,
            y: 350,
            width: 60,
            height: 80,
            baseHeight: 80,
            dy: 0,
            gravity: 0.8,
            jumpPower: -18,
            isGrounded: true,
            isDucking: false,
            animFrame: 0
        };

        let obstacles = [];
        let clouds = [];
        let obstaclePool = [];
        let keys = { jump: false, duck: false };

        // Sons
        const sounds = {
            jump: document.getElementById('jumpSound'),
            hit: document.getElementById('hitSound'),
            music: document.getElementById('bgMusic')
        };

        // Pooling pour perf [web:8]
        function initPool() {
            obstaclePool = [];
            for (let i = 0; i < 20; i++) {
                obstaclePool.push({
                    x: 0, y: 0, w: 0, h: 0, type: '', text: '', active: false
                });
            }
        }

        // Inputs pros (mobile + keyboard)
        function setupInputs() {
            // Clavier
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' || e.code === 'ArrowUp') {
                    e.preventDefault();
                    keys.jump = true;
                }
                if (e.code === 'ArrowDown' || e.code === 'KeyS') {
                    keys.duck = true;
                }
                if (e.code === 'KeyP') togglePause();
            });
            document.addEventListener('keyup', (e) => {
                if (e.code === 'Space' || e.code === 'ArrowUp') keys.jump = false;
                if (e.code === 'ArrowDown' || e.code === 'KeyS') keys.duck = false;
            });

            // Boutons tactiles
            const btns = ['btnJump', 'btnDuck'];
            ['mousedown', 'touchstart'].forEach(evt => {
                btns.forEach(id => {
                    document.getElementById(id).addEventListener(evt, (e) => {
                        e.preventDefault();
                        if (id === 'btnJump') keys.jump = true;
                        else keys.duck = true;
                        document.getElementById(id).classList.add('active');
                    });
                });
            });
            ['mouseup', 'touchend', 'touchcancel'].forEach(evt => {
                btns.forEach(id => {
                    document.getElementById(id).addEventListener(evt, () => {
                        keys.jump = false;
                        keys.duck = false;
                        document.getElementById(id).classList.remove('active');
                    });
                });
            });
        }

        // Particules pro [web:9]
        function createParticles(x, y, color, count = 15) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10 - 2,
                    life: 1,
                    maxLife: 40,
                    size: Math.random() * 4 + 2,
                    color
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2;
                p.life--;
                p.vx *= 0.98;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.save();
                ctx.globalAlpha = p.life / p.maxLife;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }

        // Update logique
        function update() {
            if (gameState !== 'playing') return;

            gameTime++;

            // Inputs
            if (keys.jump && rider.isGrounded) {
                rider.dy = rider.jumpPower;
                rider.isGrounded = false;
                sounds.jump.currentTime = 0;
                sounds.jump.play().catch(() => {});
            }
            rider.isDucking = keys.duck;
            rider.height = rider.isDucking ? rider.baseHeight * 0.65 : rider.baseHeight;

            // Physique
            rider.dy += rider.gravity;
            rider.y += rider.dy;

            // Sol
            const groundY = canvas.height - 120;
            if (rider.y + rider.height > groundY) {
                rider.y = groundY - rider.height;
                rider.dy = 0;
                rider.isGrounded = true;
            }

            // Animation
            rider.animFrame += 0.2 * gameSpeed;

            // Progression
            score += 0.15 * gameSpeed;
            gameSpeed += 0.0008;
            level = Math.floor(gameSpeed / 2) + 1;

            // Shake
            if (shake > 0) {
                shake--;
            }

            // Obstacles intelligents
            if (gameTime % Math.max(40, 80 - Math.floor(gameSpeed * 5)) === 0) {
                spawnObstacle();
            }

            // Update obstacles
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];
                obs.x -= 6 * gameSpeed;

                // Collision pr√©cise
                const dx = rider.x + rider.width/2 - (obs.x + obs.w/2);
                const dy = rider.y + rider.height/2 - (obs.y + obs.h/2);
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < (rider.width + obs.w)/3) {
                    gameOver();
                    createParticles(rider.x + rider.width/2, rider.y + rider.height/2, '#FF6B35', 25);
                    sounds.hit.play().catch(() => {});
                    shake = 15;
                    return;
                }

                if (obs.x + obs.w < -50) {
                    obstacles.splice(i, 1);
                }
            }

            // Nuages parallax
            if (Math.random() < 0.008) {
                clouds.push({ x: canvas.width, y: 50 + Math.random() * 100, speed: 0.5 + Math.random() * 0.5 });
            }
            clouds.forEach((c, i) => {
                c.x -= c.speed * gameSpeed;
                if (c.x < -100) clouds.splice(i, 1);
            });

            // Update UI
            document.getElementById('score').textContent = Math.floor(score);
            document.getElementById('level').textContent = level;
            document.getElementById('highScore').textContent = Math.floor(highScore);
        }

        // Rendu optimis√© [web:10]
        function draw() {
            // Shake camera
            ctx.save();
            if (shake > 0) {
                ctx.translate(Math.random() * shake - shake/2, Math.random() * shake - shake/2);
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // D√©grad√© ciel pro
            const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#4a90e2');
            grad.addColorStop(0.5, '#87CEEB');
            grad.addColorStop(1, '#00f2fe');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Nuages glow
            ctx.fillStyle = "rgba(255,255,255,0.9)";
            ctx.shadowColor = 'rgba(255,255,255,0.5)';
            ctx.shadowBlur = 10;
            clouds.forEach(c => {
                ctx.beginPath();
                ctx.arc(c.x, c.y, 25, 0, Math.PI * 2);
                ctx.arc(c.x + 30, c.y - 12, 30, 0, Math.PI * 2);
                ctx.arc(c.x + 60, c.y, 25, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.shadowBlur = 0;

            // Sol anim√©
            ctx.fillStyle = '#2c5530';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(0, canvas.height - 90, canvas.width, 15);
            // Ligne d'herbe anim√©e
            ctx.strokeStyle = '#81C784';
            ctx.lineWidth = 3;
            for (let i = 0; i < canvas.width; i += 20) {
                ctx.beginPath();
                ctx.moveTo(i + Math.sin(gameTime * 0.01 + i * 0.01) * 5, canvas.height - 90);
                ctx.lineTo(i + 10 + Math.sin(gameTime * 0.015 + i * 0.01) * 5, canvas.height - 110);
                ctx.stroke();
            }

            // Rider am√©lior√©
            drawRider();

            // Obstacles code JS glow
            obstacles.forEach(obs => {
                // Glow
                ctx.shadowColor = obs.type === 'bird' ? '#c678dd' : '#98c379';
                ctx.shadowBlur = 15;
                
                // Bloc
                ctx.fillStyle = "#1e1e1e";
                ctx.beginPath();
                ctx.roundRect(obs.x, obs.y, obs.w, obs.h, 8);
                ctx.fill();

                ctx.shadowBlur = 0;
                ctx.strokeStyle = obs.type === 'bird' ? '#c678dd' : '#98c379';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Texte syntaxe
                ctx.fillStyle = "#61AFEF";
                ctx.font = "bold 16px 'Fira Code', 'Courier New', monospace";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(obs.text, obs.x + obs.w/2, obs.y + obs.h/2);
            });

            // Particules
            drawParticles();

            ctx.restore();
        }

        function drawRider() {
            ctx.save();
            ctx.translate(rider.x + rider.width/2, rider.y + rider.height/2);
            ctx.rotate(rider.dy * 0.015);

            // Cheval corps glow
            ctx.shadowColor = '#8d6e63';
            ctx.shadowBlur = 10;
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(-rider.width/2, -rider.height/3, rider.width, rider.height * 0.6);
            ctx.shadowBlur = 0;

            // T√™te
            ctx.fillStyle = '#A0522D';
            ctx.fillRect(rider.width/3, -rider.height/2.2, 25, 30);

            // Cavalier
            ctx.fillStyle = '#1565C0';
            ctx.shadowColor = '#1565C0';
            ctx.shadowBlur = 8;
            ctx.fillRect(-12, -rider.height/1.8, 24, 35);
            ctx.shadowBlur = 0;

            // Jambes anim√©es
            if (rider.isGrounded) {
                const legOffset = Math.sin(rider.animFrame) * 12;
                ctx.fillStyle = '#5D4037';
                ctx.fillRect(-18, rider.height/6, 10, 20 + legOffset);
                ctx.fillRect(8, rider.height/6, 10, 20 - legOffset);
            }

            ctx.restore();
        }

        function spawnObstacle() {
            const jsSnippets = [
                "ctx.fillRect()", "addEventListener()", "requestAnimationFrame()", 
                "Math.random()", "gameState = 'playing'", "localStorage.setItem()",
                "classList.add()", "await fetch()", "JSON.parse()", "canvas.getContext()"
            ];
            const isBird = Math.random() > 0.65;
            const snippet = jsSnippets[Math.floor(Math.random() * jsSnippets.length)];

            // Pool
            const obs = obstaclePool.find(o => !o.active);
            if (!obs) return;

            obs.active = true;
            obs.x = canvas.width + 50;
            obs.y = isBird ? canvas.height - 220 : canvas.height - 140;
            obs.w = isBird ? 85 : 110;
            obs.h = 35;
            obs.type = isBird ? 'bird' : 'code';
            obs.text = snippet;
            obstacles.push(obs);
        }

        // √âcrans
        function showTitle() {
            gameState = 'title';
            document.getElementById('titleScreen').classList.add('active');
            document.getElementById('gameOver').classList.remove('active');
        }

        function startGame() {
            gameState = 'playing';
            document.getElementById('titleScreen').classList.remove('active');
            sounds.music.play().catch(() => {});
            resetGame();
        }

        function togglePause() {
            if (gameState === 'playing') {
                gameState = 'paused';
                document.getElementById('pauseScreen').classList.add('active');
                sounds.music.pause();
            } else if (gameState === 'paused') {
                gameState = 'playing';
                document.getElementById('pauseScreen').classList.remove('active');
                sounds.music.play().catch(() => {});
            }
        }

        function gameOver() {
            gameState = 'gameover';
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('cavalierHighScore', highScore);
            }
            document.getElementById('finalScore').textContent = Math.floor(score);
            document.getElementById('gameOver').classList.add('active');
            sounds.music.pause();
        }

        function resetGame() {
            score = 0;
            gameSpeed = 1;
            level = 1;
            gameTime = 0;
            rider.y = canvas.height - 220;
            rider.dy = 0;
            rider.isGrounded = true;
            obstacles = [];
            clouds = [];
            particles = [];
            shake = 0;
            initPool();
        }

        function restartGame() {
            resetGame();
            gameState = 'playing';
            document.getElementById('gameOver').classList.remove('active');
            sounds.music.play().catch(() => {});
        }

        // Loop principal 60fps [web:10]
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Init pro
        setupInputs();
        initPool();
        document.getElementById('highScore').textContent = Math.floor(highScore);
        showTitle();
        gameLoop();
    </script>
</body>
</html>
